<?php
namespace Maksv;

use Bitrix\Main\Loader,
    Bitrix\Main\Data\Cache;


class DataOperation
{
    public function __construct(){}

    public static function sendInfoMessage($actualOpportunities = [], $timeFrame = '30m')
    {
        $tgBot = new \Maksv\TelegramBot();
        $message = '';
        //$message .= "‚Ñπ info ‚è∞" . date('H:i', /*strtotime('+1 minute', */strtotime('-3 hour'))/*)*/ . "\n\n";
        $message .= "‚Ñπ info " . $timeFrame . " ‚è∞" . DataOperation::actualDateFormatted() . "\n\n";

        if ($actualOpportunities['allPump']) {
            $cnt = 1;
            foreach (array_slice($actualOpportunities['allPump'], 0, 20) as $key => $symbol) {
                $cross = 'no cross. ';
                if($symbol['crossMAVal'] == 1)
                    $cross = 'cross - üíö. ';
                else if($symbol['crossMAVal'] == 2)
                    $cross = 'cross - ‚ù§. ';

                $sar = '. SAR - ' .$symbol['lastSAR']['trend'] . '. ';
                if ($symbol['sarVal'] == 1)
                    $sar = '. SAR -üü¢. ';
                else if ($symbol['sarVal'] == 2)
                    $sar = '. SAR - üî¥. ';

                $message .= $cnt . $sar . $cross .' ' . $symbol['symbolName']  . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%.' . "\n";
                //$message .= $cnt . $cross .' ' . $symbol['symbolName'] . '. RSI '.$symbol['lastRsi'].'%' . $divergence . ' –ü–æ–∫—É–ø–∫–∏ ' . $symbol['buyChangePercent'] . '%.' . ' –ü—Ä–æ–¥–∞–∂–∏ ' . $symbol['sellChangePercent'] . '%' . ' ' . $symbol['snapshots'][0]['timeMark'] . '-' . $symbol['snapshots'][1]['timeMark'] . "\n";
                $cnt++;
            }
        }
        $message .= "\n";

        if ($actualOpportunities['allDump']) {

            $cnt = 1;
            foreach (array_slice($actualOpportunities['allDump'], 0, 20) as $key => $symbol) {
                $cross = 'no cross. ';
                if($symbol['crossMAVal'] == 1)
                    $cross = 'cross - üíö. ';
                else if($symbol['crossMAVal'] == 2)
                    $cross = 'cross - ‚ù§. ';

                $sar = '. SAR - ' .$symbol['lastSAR']['trend'] . '. ';
                if ($symbol['sarVal'] == 1)
                    $sar = '. SAR -üü¢. ';
                else if ($symbol['sarVal'] == 2)
                    $sar = '. SAR - üî¥. ';

                $message .= $cnt . $sar . $cross .' ' . $symbol['symbolName'] . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%.' . "\n";
                $cnt++;
            }
        }

        if (!$actualOpportunities['allDump'] && !$actualOpportunities['allPump']) {
            $message .= "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç\n";
        }

        $message .= "\n";
        $sendRes = $tgBot->messageToTelegram($message, '@cryptoHelperDev');

        return $sendRes;
    }

    public static function sendSignalMessage($pump = [], $dump = [], $chatName = '@cryptoHelperDev', $timeFrame = '')
    {
        $tgBot = new \Maksv\TelegramBot();
        $message = '';
        //$message .= "‚Ñπ info ‚è∞" . date('H:i', /*strtotime('+1 minute', */strtotime('-3 hour'))/*)*/ . "\n\n";
        $message .= "‚Ñπ info " . $timeFrame . " ‚è∞" .  DataOperation::actualDateFormatted() . "\n\n";

        if ($pump) {
            $message .= "‚¨Ü long:\n";

            $cnt = 1;
            foreach (array_slice($pump, 0, 12) as $key => $symbol) {
                $cross = 'no cross. ';
                if($symbol['crossMAVal'] == 1)
                    $cross = 'cross - üíö. ';
                else if($symbol['crossMAVal'] == 2)
                    $cross = 'cross - ‚ù§. ';

                $sar = '. SAR - ' .$symbol['lastSAR']['trend'] . '. ';
                if ($symbol['sarVal'] == 1)
                    $sar = '. SAR -üü¢. ';
                else if ($symbol['sarVal'] == 2)
                    $sar = '. SAR - üî¥. ';

                $parentApprove = '';
                if ($symbol['secondFilter'])
                    $parentApprove = 'Parent approve.';

                $message .= $cnt . $sar . $cross .' ' . $symbol['symbolName'] . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%.' . $parentApprove . "\n";
                //$message .= $cnt . $sar . $cross .' ' . $symbol['symbolName'] . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%.' . ' –ü–æ–∫—É–ø–∫–∏ ' . $symbol['buyChangePercent'] . '%.' . ' –ü—Ä–æ–¥–∞–∂–∏ ' . $symbol['sellChangePercent'] . '%' . "\n\n";
                //$message .= $cnt . $cross .' ' . $symbol['symbolName'] . '. RSI '.$symbol['lastRsi'].'%' . $divergence . ' –ü–æ–∫—É–ø–∫–∏ ' . $symbol['buyChangePercent'] . '%.' . ' –ü—Ä–æ–¥–∞–∂–∏ ' . $symbol['sellChangePercent'] . '%' . ' ' . $symbol['snapshots'][0]['timeMark'] . '-' . $symbol['snapshots'][1]['timeMark'] . "\n\n";
                $cnt++;
            }
        } else {
            $message .= "long —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç\n";
        }
        $message .= "\n";

        if ($dump) {
            $message .= "‚¨á short:\n";

            $cnt = 1;
            foreach (array_slice($dump, 0, 12) as $key => $symbol) {
                $cross = 'no cross. ';
                if($symbol['crossMAVal'] == 1)
                    $cross = 'cross - üíö. ';
                else if($symbol['crossMAVal'] == 2)
                    $cross = 'cross - ‚ù§. ';

                $sar = '. SAR - ' .$symbol['lastSAR']['trend'] . '. ';
                if ($symbol['sarVal'] == 1)
                    $sar = '. SAR -üü¢. ';
                else if ($symbol['sarVal'] == 2)
                    $sar = '. SAR - üî¥. ';

                $parentApprove = '';
                if ($symbol['secondFilter'])
                    $parentApprove = 'Parent approve.';

                $message .= $cnt . $sar . $cross .' ' . $symbol['symbolName'] . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%. ' . $parentApprove . "\n";
                //$message .= $cnt . $sar . $cross .' ' . $symbol['symbolName'] . '. P '.$symbol['lastPriceChange'].'%.' . ' OI '.$symbol['lastOpenInterest'].'%.' . ' –ü—Ä–æ–¥–∞–∂–∏ ' . $symbol['sellChangePercent'] . '%.' . ' –ü–æ–∫—É–ø–∫–∏ ' . $symbol['buyChangePercent'] . '%' . "\n\n";
                $cnt++;
            }
        } else {
            $message .= "short —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç\n";
        }
        $message .= "\n";
        $sendRes = $tgBot->messageToTelegram($message, $chatName);

        return $sendRes;
    }

    public static function saveSignalToIblock($timeframe = '30m', $iblockCode = 'bybit', $isMaster = false)
    {
        /*if (!$actualOpportunities)
            $actualSymbolsAr = (json_decode(file_get_contents($_SERVER['DOCUMENT_ROOT'] . '/upload/' . $iblockCode . 'Exchange/'.$timeframe.'/actualMarketVolumes.json'), true))['STRATEGIES'] ?? [];*/

        $opportunitiesPath = $_SERVER['DOCUMENT_ROOT'] . '/upload/' . $iblockCode . 'V5' . 'Exchange/'.$timeframe.'/actualMarketVolumes.json';
        $opportunitiesFileAr = \CFile::MakeFileArray($opportunitiesPath);
        $opportunitiesFileId = \CFile::SaveFile($opportunitiesFileAr, 'opportunities');
        $res = ['status' => false];

        if ($opportunitiesFileId && \CModule::IncludeModule("iblock")) {

            $iblockMap = [
                'bybit' => 3
            ];

            $nameTimeFrame = $timeframe;
            if ($isMaster)
                $timeframe = 'master';

            $iblockSectionsMap = [
                '30m' => 2,
                '1h' => 3,
                '4h' => 4,
                '1d' => 1,
                'master' => 5
            ];

            $elementProperty = [
                'STRATEGIES_FILE' => $opportunitiesFileId,
            ];

            $el = new \CIBlockElement;
            $arLoadElementArray = [
                //"MODIFIED_BY"    => $modifiedBy,
                "IBLOCK_SECTION_ID" => $iblockSectionsMap[$timeframe],
                "IBLOCK_ID" => $iblockMap[$iblockCode],
                //"NAME" => date('H:i', /*strtotime('+1 minute', */ strtotime('-3 hour'))/*)*/,
                "NAME" => DataOperation::actualDateFormatted() . ' / ' . $nameTimeFrame,
                "ACTIVE" => 'Y',
                "PROPERTY_VALUES" => $elementProperty,
            ];

            if ($elementId = $el->Add($arLoadElementArray))
                return ['status' => true, 'data' => $elementId];
            else
                return ['status' => false, 'data' => $el->LAST_ERROR];
        }
        return $res;
    }

    /*public static function actualDateFormatted() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        $date = new \DateTime();

        // –í—ã—á–∏—Ç–∞–µ–º 3 —á–∞—Å–∞
        $date->modify('-3 hours');

        // –û–∫—Ä—É–≥–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö 30 –º–∏–Ω—É—Ç
        $minutes = (int)$date->format('i');
        if ($minutes < 15) {
            $date->setTime($date->format('H'), 0);
        } elseif ($minutes >= 15 && $minutes < 45) {
            $date->setTime($date->format('H'), 30);
        } else {
            $date->setTime($date->format('H') + 1, 0);
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        $formattedTime = $date->format('H:i d.m');

        return $formattedTime;
    }*/
    public static function actualDateFormatted($inputTime = null)
    {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        $date = new \DateTime();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω–æ –ª–∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'H:i'
        if ($inputTime) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ö–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –≤ –æ–±—ä–µ–∫—Ç DateTime (–¥–∞—Ç–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–∫—É—â–µ–π)
            $timeParts = explode(':', $inputTime);
            if (count($timeParts) == 2 && is_numeric($timeParts[0]) && is_numeric($timeParts[1])) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (—Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π)
                $date->setTime((int)$timeParts[0], (int)$timeParts[1]);
            } else {
                throw new \Exception("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: $inputTime");
            }
        }

        // –í—ã—á–∏—Ç–∞–µ–º 3 —á–∞—Å–∞
        $date->modify('-3 hours');

        // –û–∫—Ä—É–≥–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö 30 –º–∏–Ω—É—Ç
        $minutes = (int)$date->format('i');
        if ($minutes < 15) {
            $date->setTime($date->format('H'), 0);
        } elseif ($minutes >= 15 && $minutes < 45) {
            $date->setTime($date->format('H'), 30);
        } else {
            $date->setTime($date->format('H') + 1, 0);
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        $formattedTime = $date->format('H:i d.m');

        return $formattedTime;
    }
}
